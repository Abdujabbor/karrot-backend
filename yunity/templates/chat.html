{% extends '_base.html' %}

{% block script %}

    <script src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"
            type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js" type="text/javascript"></script>
    <!-- All our client code, inlined to easy reading -->
    <script type="text/javascript">
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });


        $(document).ready(function(){
            $('#new_chat').click(function(ev) {
                ev.preventDefault();
                $.ajax({
                    url: '/api/chat/',
                    data: {
                        participants: [1,2]
                    },
                    type: 'POST'
                }).done(function(data) {
                            console.log(data);
                            $("#chatid").val(data.data.chatid);
                        });
            });
            $('#send').click(function(ev){
                ev.preventDefault();
                chatid = $("#chatid").val();
                $.ajax({
                    url: '/api/chat/'+chatid+'/messages/',
                    data: {content: $('#compose').val(),
                            type: 'TEXT',
                            id: chatid,
                            },
                    type: 'POST',
                });

            });
            $('#connect').click(function(ev){
                ev.preventDefault();

                /* Connection configuration to our WAMP router */
                var connection = new autobahn.Connection({
                    url: 'ws://127.0.0.1:8080/ws',
                    realm: 'realm1'
                });

                /* When the connection is opened, execute this code */
                connection.onopen = function(session) {

                    console.log("connected!");

                    var clients = document.getElementById("clients");

                    /* When we receive the 'clientstats' event, run this function */
                    topic = 'yunity.public.chat.'+$('#chatid').val();
                    session.subscribe(topic, function(args){
                        var msg = args[0];
                        if(msg != '') {
                            //$('#messages').append('<li>('+msg.timestamp+'): '+msg.content+'</li>');
                            $('#messages').append('<li>'+JSON.stringify(msg)+'</li>');
                        }

                    });

                };

                // Open the WAMP connection with the router.
                connection.open();

            });
        });

    </script>

{% endblock %}

{% block content %}

    <h1> Yunity Chat </h1>
    <a href="#" id="new_chat">Create new chat</a><br>
    Chatid: <textarea id="chatid">{{ chatid }}</textarea><br>

    <a id="connect" href="#">Connect</a><br>

    <ul id="messages"></ul>
    <textarea id="compose"></textarea><br>
    <a href='#' id="send">Send</a>

{% endblock %}